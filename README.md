# Pulumi Amplify Proof-of-concept

This repository is a proof-of-concept of a GraphQL application using AppSync and Cognito which is managed entiely by Pulumi.  This project also makes use of AWS Amplify as a code generator, but not as a cloud provisioner.

This example implements a React app which allows users to create simple notes which are stored in a database.  The notes can only be updated and deleted by their original creator.

The project works like this:

* The `src` directory contains the React app
* The `amplify` directory contains a GraphQL schema and AppSync resolvers which were generated by Amplify
* The `__main__.py` file contains a Pulumi program which deploys the GraphQL application using the files in the Amplify directory
  * Every time the Pulumi program deploys, it creates an `aws-exports.js` file in `src` with the relevant parameters for the frontend


**To deploy this example**:

* Checkout the repo and create and enter a Python venv
* Run `pip install -r requirements.txt`
* Run `amplify init` and confirm that you will use the existing environment `dev`
* Run `amplify api gql-compile` to generate code in the `amplify` directory
* Run `pulumi up` to create the cloud resources based on `amplify`
* Run `npm install` to install the frontend dependencies
* Run `npm start` and view the given localhost URL in your browser


**To update the schema:**

If the schema is changed, you must use Amplify to regenerate the necessary code:

* `amplify codegen` to rebuild the client helper classes
* `amplify api gql-compile` to rebuild the backend schema and resolvers
* `pulumi up` to push the new backend configuration to AppSync


**To use this Pulumi code with a new Amplify project:**

If you wish to create a new application based on this example, you should start with an empty directory and start to create an Amplify project:

* `amplify init`
* `amplify add api`
  * You MUST choose Cognito for authentication.  Any settings you provide for Cognito are ignored, as the Pulumi script will create its own.
* `amplify codegen add`
* _Do **not** call `amplify push`!_
* Copy `__main__.py` from this project
* Modify the `graphql_types` and `amplify_api_name` name variables to match your Amplify project



## Known issues and limitations:

* Although Amplify does not push any of the cloud resources for the API or Cognito, it will still create an Amplify app and deployment bucket which serve no purpose
* The Pulumi program assumes a DynamoDB backend
* The Dynamo tables have only a single hash key called `id` each
* The Pulumi program assumes Cognito for authentication
